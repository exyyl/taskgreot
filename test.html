<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
        }
        h1 {
            color: var(--tg-theme-button-color, #40a7e3);
        }
        button {
            background: var(--tg-theme-button-color, #40a7e3);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 10px;
            padding: 15px 30px;
            font-size: 18px;
            margin: 10px;
            cursor: pointer;
            width: 100%;
            max-width: 300px;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì± Mini App</h1>
        
        <div class="status" id="status">
            –ó–∞–≥—Ä—É–∑–∫–∞...
        </div>
        <input id="msgIdInput" class="hidden" type="text" placeholder="ID —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è" style="width:100%;max-width:300px;padding:10px;border-radius:8px;border:1px solid #ddd;margin-top:10px;" />
        <button onclick="deleteByInput()" id="deleteByIdBtn" class="hidden">
            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ø–æ ID
        </button>
        
        <button onclick="sendUpdate()" id="updateBtn">
            üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        </button>
        
        <button onclick="sendCustomMessage()" id="customBtn" class="hidden">
            üìù –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–≤–æ—ë —Å–æ–æ–±—â–µ–Ω–∏–µ
        </button>
        
        <button onclick="closeApp()">
            ‚úñÔ∏è –ó–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        </button>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.expand(); // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        const user = tg.initDataUnsafe?.user;
        const chatId = user?.id; // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—á–∞—Ç —Å –±–æ—Ç–æ–º)
        
        // URL –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π)
        const BOT_TOKEN = '8550806482:AAHXwm6bsUFCQWhSZHRX2inIkhVjAHpKtQ4';
        const API_URL = `https://api.telegram.org/bot${BOT_TOKEN}`;
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–∑–æ–≤–∞ –º–µ—Ç–æ–¥–æ–≤ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ API
        async function callBotMethod(method, params = {}) {
            try {
                const response = await fetch(`${API_URL}/${method}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                return { ok: false, error: error.message };
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
        async function deleteMessage(messageId) {
            if (!messageId) return { ok: false };
            
            return await callBotMethod('deleteMessage', {
                chat_id: chatId,
                message_id: messageId
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function sendNewMessage(text) {
            return await callBotMethod('sendMessage', {
                chat_id: chatId,
                text: text,
                parse_mode: 'HTML'
            });
        }
        
        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è - –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        async function initApp() {
            updateStatus('üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è...');
            
            // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Telegram Web App –¥–∞–Ω–Ω—ã—Ö
            // –∏–ª–∏ –∏–∑ localStorage
            // –ø—Ä–æ–±—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–ª—é—á–µ–π ‚Äî –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ ID —Å–æ—Ö—Ä–∞–Ω—ë–Ω –ø–æ–¥ –¥—Ä—É–≥–∏–º –∫–ª—é—á–æ–º
            let lastMessageId = localStorage.getItem(`last_msg_${chatId}`) || localStorage.getItem(`last_msg`) || localStorage.getItem(`tg_last_msg_${chatId}`) || localStorage.getItem(`tg_last_msg`);
            
            if (lastMessageId) {
                updateStatus('üóëÔ∏è –£–¥–∞–ª—è–µ–º –ø—Ä–æ—à–ª–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...');
                
                // –£–¥–∞–ª—è–µ–º –ø—Ä–æ—à–ª–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                const deleteResult = await deleteMessage(lastMessageId);
                
                if (deleteResult.ok) {
                    updateStatus('‚úÖ –ü—Ä–æ—à–ª–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
                    try { localStorage.removeItem(`last_msg_${chatId}`); } catch (e) {}
                    try { localStorage.removeItem(`last_msg`); } catch (e) {}
                    try { localStorage.removeItem(`tg_last_msg_${chatId}`); } catch (e) {}
                    try { localStorage.removeItem(`tg_last_msg`); } catch (e) {}
                } else {
                    updateStatus('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å (–≤–æ–∑–º–æ–∂–Ω–æ, —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ç–∞—Ä—à–µ 48 —á–∞—Å–æ–≤)');
                }
            }
                // –ï—Å–ª–∏ ID –Ω–µ –Ω–∞–π–¥–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞
                document.getElementById('msgIdInput').classList.remove('hidden');
                document.getElementById('deleteByIdBtn').classList.remove('hidden');
                updateStatus('‚ÑπÔ∏è ID –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤—ã –º–æ–∂–µ—Ç–µ –≤–≤–µ—Å—Ç–∏ –µ–≥–æ –≤—Ä—É—á–Ω—É—é –Ω–∏–∂–µ');
                // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º ‚Äî –æ—Ç–ø—Ä–∞–≤–∏–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–∞–ª–µ–µ

            }

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            updateStatus('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...');
            
            const welcomeText = `‚úÖ <b>–ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ!</b>\n\n` +
                               `üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${user?.first_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'} ${user?.last_name || ''}\n` +
                               `üÜî ID: ${chatId}\n` +
                               `‚è∞ –í—Ä–µ–º—è: ${new Date().toLocaleTimeString()}`;
            
            const sendResult = await sendNewMessage(welcomeText);
            
            if (sendResult.ok) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                const newMessageId = sendResult.result.message_id;
                localStorage.setItem(`last_msg_${chatId}`, newMessageId);
                
                updateStatus('‚úÖ –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
                document.getElementById('customBtn').classList.remove('hidden');
            } else {
                updateStatus('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –≤ Telegram, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ
            tg.ready();
        }

        // –£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ ID, –≤–≤–µ–¥—ë–Ω–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
        async function deleteByInput() {
            const input = document.getElementById('msgIdInput');
            const id = input.value && input.value.trim();
            if (!id) {
                updateStatus('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID —Å–æ–æ–±—â–µ–Ω–∏—è');
                return;
            }

            updateStatus('üóëÔ∏è –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ –≤–≤–µ–¥—ë–Ω–Ω–æ–º—É ID...');
            const res = await deleteMessage(id);
            if (res.ok) {
                updateStatus('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
                try { localStorage.removeItem(`last_msg_${chatId}`); } catch (e) {}
                try { localStorage.removeItem(`last_msg`); } catch (e) {}
                try { localStorage.removeItem(`tg_last_msg_${chatId}`); } catch (e) {}
                try { localStorage.removeItem(`tg_last_msg`); } catch (e) {}
                input.value = '';
                input.classList.add('hidden');
                document.getElementById('deleteByIdBtn').classList.add('hidden');
            } else {
                updateStatus('‚ö†Ô∏è –ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ ID –∏–ª–∏ —Å—Ä–æ–∫ (48—á)');
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        function updateStatus(text) {
            document.getElementById('status').innerHTML = text;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è (–ø–æ –∫–Ω–æ–ø–∫–µ)
        async function sendUpdate() {
            updateStatus('üîÑ –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ...');
            
            // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            let lastMessageId = localStorage.getItem(`last_msg_${chatId}`);
            
            // –£–¥–∞–ª—è–µ–º –ø—Ä–æ—à–ª–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (lastMessageId) {
                await deleteMessage(lastMessageId);
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
            const updateText = `üîÑ <b>–°–æ–æ–±—â–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!</b>\n\n` +
                              `–í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${new Date().toLocaleTimeString()}`;
            
            const sendResult = await sendNewMessage(updateText);
            
            if (sendResult.ok) {
                localStorage.setItem(`last_msg_${chatId}`, sendResult.result.message_id);
                updateStatus('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
                tg.showAlert('–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!');
            } else {
                updateStatus('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function sendCustomMessage() {
            const customText = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:', '–ü—Ä–∏–≤–µ—Ç –æ—Ç Mini App!');
            
            if (customText) {
                updateStatus('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è...');
                
                // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                let lastMessageId = localStorage.getItem(`last_msg_${chatId}`);
                
                // –£–¥–∞–ª—è–µ–º –ø—Ä–æ—à–ª–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                if (lastMessageId) {
                    await deleteMessage(lastMessageId);
                }
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º —Ç–µ–∫—Å—Ç–æ–º
                const sendResult = await sendNewMessage(`üìù <b>–°–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ Mini App:</b>\n\n${customText}`);
                
                if (sendResult.ok) {
                    localStorage.setItem(`last_msg_${chatId}`, sendResult.result.message_id);
                    updateStatus('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
                } else {
                    updateStatus('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
                }
            }
        }
        
        // –ó–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        function closeApp() {
            tg.close();
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" –≤ Telegram
        tg.onEvent('backButtonClicked', function() {
            closeApp();
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –≤ Telegram
        tg.BackButton.show();
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
