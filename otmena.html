<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–û—Ç–º–µ–Ω–∞ –∑–∞–¥–∞–Ω–∏—è</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        
        body {
            background: #f0f2f5;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        
        .container {
            background: white;
            border-radius: 24px;
            padding: 32px 24px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }
        
        h1 {
            font-size: 28px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 16px;
            letter-spacing: -0.3px;
        }
        
        .status {
            background: #f8f9fc;
            border-radius: 16px;
            padding: 16px;
            margin: 24px 0;
            font-size: 16px;
            color: #4a5568;
            border: 1px solid #e9edf4;
            word-break: break-word;
        }
        
        .cancel-btn {
            background: #ff3b30;
            color: white;
            border: none;
            border-radius: 60px;
            padding: 18px 32px;
            font-size: 18px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3);
            margin-bottom: 16px;
            letter-spacing: 0.3px;
        }
        
        .cancel-btn:active {
            transform: scale(0.97);
            background: #e6352b;
            box-shadow: 0 2px 6px rgba(255, 59, 48, 0.4);
        }
        
        .cancel-btn:disabled {
            background: #b8c2d0;
            box-shadow: none;
            transform: none;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .info-text {
            font-size: 14px;
            color: #718096;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px dashed #d0d9e8;
        }
        
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        .error {
            color: #e53e3e;
            font-size: 14px;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚è≥ –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ</h1>
        
        <div class="status" id="statusMessage">
            –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...
        </div>
        
        <button class="cancel-btn" id="cancelButton" disabled>
            <span id="buttonText">–û—Ç–º–µ–Ω–∏—Ç—å</span>
            <span id="buttonLoader" class="loader hidden"></span>
        </button>
        
        <div class="info-text">
            –ù–∞–∂–º–∏—Ç–µ ¬´–û—Ç–º–µ–Ω–∏—Ç—å¬ª, —á—Ç–æ–±—ã —É–≤–µ–¥–æ–º–∏—Ç—å –±–æ—Ç–∞<br>–ü—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ
        </div>
        
        <div id="errorMessage" class="error hidden"></div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Mini App
        const tg = window.Telegram.WebApp;
        tg.expand(); // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
        tg.ready();
        
        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const cancelButton = document.getElementById('cancelButton');
        const statusMessage = document.getElementById('statusMessage');
        const buttonText = document.getElementById('buttonText');
        const buttonLoader = document.getElementById('buttonLoader');
        const errorDiv = document.getElementById('errorMessage');
        
        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
        const TOKEN_URL = 'https://raw.githubusercontent.com/exyyl/-taskgreot/main/token.txt';
        const IMAGE_URL = 'https://raw.githubusercontent.com/exyyl/-taskgreot/main/otmena.PNG';
        
        let botToken = null;
        let currentUserId = null;
        let isProcessing = false;
        
        // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            currentUserId = tg.initDataUnsafe.user.id;
            statusMessage.innerText = '‚úÖ –ì–æ—Ç–æ–≤–æ. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –æ—Ç–º–µ–Ω—ã.';
            cancelButton.disabled = false;
        } else {
            statusMessage.innerText = '‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞.';
            console.error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞
        async function fetchBotToken() {
            try {
                const response = await fetch(TOKEN_URL);
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–∫–µ–Ω–∞: ${response.status}`);
                }
                let token = await response.text();
                // –û—á–∏—â–∞–µ–º –æ—Ç –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø—Ä–æ–±–µ–ª–æ–≤ –∏ —Å–∏–º–≤–æ–ª–æ–≤ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
                token = token.trim();
                if (!token) {
                    throw new Error('–¢–æ–∫–µ–Ω –ø—É—Å—Ç–æ–π');
                }
                return token;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:', error);
                throw error;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞
        async function deletePreviousBotMessage(chatId) {
            const storageKey = `last_bot_message_${chatId}`;
            const lastMessageId = localStorage.getItem(storageKey);
            
            if (!lastMessageId || !botToken) {
                return; // –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–ª–∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞
            }
            
            try {
                const url = `https://api.telegram.org/bot${botToken}/deleteMessage`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: chatId,
                        message_id: parseInt(lastMessageId, 10)
                    })
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    console.log(`–°–æ–æ–±—â–µ–Ω–∏–µ ${lastMessageId} —É–¥–∞–ª–µ–Ω–æ`);
                    localStorage.removeItem(storageKey); // –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
                } else {
                    // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏–ª–∏ —É–∂–µ —É–¥–∞–ª–µ–Ω–æ - —Ç–æ–∂–µ —É–¥–∞–ª—è–µ–º –∏–∑ localStorage
                    if (result.error_code === 400) {
                        console.log('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ —É–∂–µ —É–¥–∞–ª–µ–Ω–æ');
                        localStorage.removeItem(storageKey);
                    } else {
                        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ:', result);
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                // –ù–µ —É–¥–∞–ª—è–µ–º –∏–∑ localStorage, —á—Ç–æ–±—ã –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ URL
        async function sendTelegramPhotoWithUrl(chatId, photoUrl, caption = '') {
            if (!botToken) {
                throw new Error('–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
            }
            
            // –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            await deletePreviousBotMessage(chatId);
            
            const url = `https://api.telegram.org/bot${botToken}/sendPhoto`;
            
            const formData = new FormData();
            formData.append('chat_id', chatId);
            formData.append('photo', photoUrl);
            if (caption) {
                formData.append('caption', caption);
            }
            
            const response = await fetch(url, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (!result.ok) {
                throw new Error(`–û—à–∏–±–∫–∞ Telegram API: ${result.description}`);
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            if (result.result && result.result.message_id) {
                const storageKey = `last_bot_message_${chatId}`;
                localStorage.setItem(storageKey, result.result.message_id);
                console.log(`–°–æ—Ö—Ä–∞–Ω–µ–Ω ID –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: ${result.result.message_id}`);
            }
            
            return result;
        }
        
        // –†–µ–∑–µ—Ä–≤–Ω—ã–π –º–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏ (–µ—Å–ª–∏ sendPhoto –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç)
        async function sendTelegramPhotoWithUrlAlternative(chatId, photoUrl, caption = '') {
            if (!botToken) {
                throw new Error('–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
            }
            
            await deletePreviousBotMessage(chatId);
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º sendMessage —Å HTML —Ä–∞–∑–º–µ—Ç–∫–æ–π, —Å–æ–¥–µ—Ä–∂–∞—â–µ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    chat_id: chatId,
                    text: `<a href="${photoUrl}">&#8205;</a>\n${caption}`,
                    parse_mode: 'HTML',
                    disable_web_page_preview: false
                })
            });
            
            const result = await response.json();
            
            if (!result.ok) {
                throw new Error(`–û—à–∏–±–∫–∞ Telegram API (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥): ${result.description}`);
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            if (result.result && result.result.message_id) {
                const storageKey = `last_bot_message_${chatId}`;
                localStorage.setItem(storageKey, result.result.message_id);
            }
            
            return result;
        }
        
        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É
        async function handleCancel() {
            if (isProcessing) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if (!currentUserId) {
                showError('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return;
            }
            
            isProcessing = true;
            cancelButton.disabled = true;
            buttonText.classList.add('hidden');
            buttonLoader.classList.remove('hidden');
            errorDiv.classList.add('hidden');
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–∫–µ–Ω, –µ—Å–ª–∏ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
                if (!botToken) {
                    statusMessage.innerText = 'üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–∫–µ–Ω–∞...';
                    botToken = await fetchBotToken();
                }
                
                statusMessage.innerText = 'üîÑ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ...';
                
                // –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
                try {
                    await sendTelegramPhotoWithUrl(currentUserId, IMAGE_URL, '–ó–∞–¥–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
                } catch (photoError) {
                    console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ç–æ, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥:', photoError);
                    // –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥
                    await sendTelegramPhotoWithUrlAlternative(currentUserId, IMAGE_URL, '–ó–∞–¥–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
                }
                
                statusMessage.innerText = '‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –ü—Ä–µ–¥—ã–¥—É—â–µ–µ —É–¥–∞–ª–µ–Ω–æ.';
                
                // –£—Å–ø–µ—à–Ω–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                setTimeout(() => {
                    statusMessage.innerText = '‚úÖ –ì–æ—Ç–æ–≤–æ. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –æ—Ç–º–µ–Ω—ã.';
                }, 3000);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                statusMessage.innerText = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ';
                showError(error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ');
            } finally {
                isProcessing = false;
                cancelButton.disabled = false;
                buttonText.classList.remove('hidden');
                buttonLoader.classList.add('hidden');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–∫–∏
        function showError(message) {
            errorDiv.innerText = `‚ö†Ô∏è ${message}`;
            errorDiv.classList.remove('hidden');
        }
        
        // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É
        cancelButton.addEventListener('click', handleCancel);
        
        // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–∫–µ–Ω–∞ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
        (async function preloadToken() {
            try {
                if (!botToken) {
                    botToken = await fetchBotToken();
                    console.log('–¢–æ–∫–µ–Ω –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω');
                }
            } catch (error) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–∫–µ–Ω, –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ');
            }
        })();
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        tg.onEvent('viewportChanged', function() {
            tg.expand();
        });
    </script>
</body>
</html>
