<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Task Greot | –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –∑–∞–¥–∞–Ω–∏–π</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* ... –≤—Å–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */
    </style>
</head>
<body>
    <!-- ... –≤–µ—Å—å HTML –æ—Å—Ç–∞—ë—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... -->

    <script>
        // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================
        const CONFIG = {
            // URL —Ñ–∞–π–ª–æ–≤
            TOKEN_FILE_URL: 'https://raw.githubusercontent.com/exyyl/taskgreot/main/token.txt',
            BD_FILE_URL: 'https://raw.githubusercontent.com/exyyl/-taskgreot/main/bd.txt',
            
            // ID –≥—Ä—É–ø–ø—ã –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            GROUP_CHAT_ID: '-1003683579168',
            
            // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
            POINT_TO_RUB: 1,
            
            // ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
            ADMIN_CHAT_ID: '7621683704',
            
            // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ç–æ–∫–µ–Ω–∞ (–±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞)
            TELEGRAM_BOT_TOKEN: ''
        };

        // ==================== –°–û–°–¢–û–Ø–ù–ò–ï ====================
        let currentUser = null;
        let botTokenLoaded = false;
        let selectedWithdrawMethod = null;
        let withdrawData = {};
        let lastWithdrawTime = localStorage.getItem('last_withdraw_time');
        let totalTasksTaken = parseInt(localStorage.getItem('total_tasks_taken')) || 0;

        // ==================== –ó–ê–ì–†–£–ó–ö–ê –¢–û–ö–ï–ù–ê –ò–ó –§–ê–ô–õ–ê ====================
        async function loadBotToken() {
            console.log('üîë –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–∫–µ–Ω–∞ –∏–∑ —Ñ–∞–π–ª–∞...');
            
            try {
                const timestamp = Date.now();
                const url = `${CONFIG.TOKEN_FILE_URL}?t=${timestamp}`;
                
                console.log(`üìÅ –ó–∞–ø—Ä–æ—Å –∫: ${url}`);
                
                const response = await fetch(url, {
                    method: 'GET',
                    cache: 'no-cache',
                    headers: {
                        'Accept': 'text/plain'
                    },
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const token = (await response.text()).trim();
                console.log('üì¶ –ü–æ–ª—É—á–µ–Ω —Ç–æ–∫–µ–Ω –∏–∑ —Ñ–∞–π–ª–∞ (–ø–µ—Ä–≤—ã–µ 10 —Å–∏–º–≤–æ–ª–æ–≤):', token.substring(0, 10) + '...');
                
                if (token && token.length > 20 && token.includes(':')) {
                    CONFIG.TELEGRAM_BOT_TOKEN = token;
                    botTokenLoaded = true;
                    console.log('‚úÖ –¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –≤–∞–ª–∏–¥–µ–Ω');
                    return true;
                } else {
                    console.error('‚ùå –ü–æ–ª—É—á–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω:', token);
                    showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞', 'error');
                    return false;
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–∫–µ–Ω–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞', 'error');
                return false;
            }
        }

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –¢–ï–õ–ï–ì–†–ê–ú ====================
        async function initTelegram() {
            console.log('üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp...');
            
            if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
                const webApp = Telegram.WebApp;
                
                try {
                    webApp.ready();
                    console.log('‚úÖ Telegram WebApp –≥–æ—Ç–æ–≤');
                    
                    webApp.expand();
                    webApp.enableClosingConfirmation();
                    webApp.setBackgroundColor('#0F172A');
                    
                    const user = webApp.initDataUnsafe?.user;
                    console.log('üë§ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram:', user);
                    
                    if (user) {
                        currentUser = {
                            id: user.id,
                            first_name: user.first_name || '',
                            last_name: user.last_name || '',
                            username: user.username || '',
                            photo_url: user.photo_url || null,
                            auth_date: user.auth_date || Math.floor(Date.now() / 1000)
                        };
                        
                        console.log('‚úÖ –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. ID:', currentUser.id);
                        return true;
                    } else {
                        console.warn('‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã –æ—Ç Telegram');
                    }
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram WebApp:', error);
                }
            } else {
                console.warn('‚ö†Ô∏è Telegram WebApp –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-—Ä–µ–∂–∏–º');
            }
            
            // –î–µ–º–æ-—Ä–µ–∂–∏–º –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            currentUser = {
                id: 7621683704,
                first_name: '–¢–µ—Å—Ç–æ–≤—ã–π',
                last_name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                username: 'test_user',
                photo_url: null,
                auth_date: Math.floor(Date.now() / 1000)
            };
            
            console.log('‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ–º–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å. ID:', currentUser.id);
            return false;
        }

        // ==================== –£–õ–£–ß–®–ï–ù–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –ë–ê–õ–ê–ù–°–ê ====================
        async function loadBalanceFromFile() {
            if (!currentUser?.id) {
                console.log('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞');
                return { balance: 0, level: '–æ–±—ã—á–Ω—ã–π' };
            }
            
            const userIdStr = currentUser.id.toString();
            console.log(`üì• –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID: ${userIdStr}`);
            
            try {
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
                const timestamp = Date.now();
                const random = Math.random().toString(36).substring(7);
                const url = `${CONFIG.BD_FILE_URL}?t=${timestamp}&r=${random}`;
                
                console.log(`üîó –ó–∞–ø—Ä–æ—Å –∫: ${url}`);
                
                const response = await fetch(url, {
                    method: 'GET',
                    cache: 'no-store', // –ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫—ç—à–∞
                    headers: {
                        'Accept': 'text/plain',
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    },
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                console.log('üìÑ –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞, –¥–ª–∏–Ω–∞:', text.length, '—Å–∏–º–≤–æ–ª–æ–≤');
                
                if (!text || !text.trim()) {
                    console.log('üìÑ –§–∞–π–ª –ø—É—Å—Ç–æ–π');
                    return { balance: 0, level: '–æ–±—ã—á–Ω—ã–π' };
                }
                
                const lines = text.trim().split('\n');
                console.log(`üìä –ù–∞–π–¥–µ–Ω–æ —Å—Ç—Ä–æ–∫ –≤ —Ñ–∞–π–ª–µ: ${lines.length}`);
                
                // –ë–æ–ª–µ–µ –≥–∏–±–∫–∏–π –ø–∞—Ä—Å–∏–Ω–≥
                for (let line of lines) {
                    line = line.trim();
                    if (!line) continue;
                    
                    console.log(`üîç –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä–æ–∫–∏: "${line}"`);
                    
                    // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
                    let parts = [];
                    
                    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: ID –ë–ê–õ–ê–ù–° –£–†–û–í–ï–ù–¨
                    parts = line.split(/\s+/);
                    
                    // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å, –ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–∏–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
                    if (parts.length < 3) {
                        parts = line.split(/[\t,;|]+/);
                    }
                    
                    console.log('–†–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–µ —á–∞—Å—Ç–∏:', parts);
                    
                    if (parts.length >= 2) {
                        const lineUserId = parts[0].trim();
                        console.log(`üÜî –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º: ${lineUserId} —Å ${userIdStr}`);
                        
                        if (lineUserId === userIdStr) {
                            const balance = parseInt(parts[1]);
                            const level = parts[2] ? parts[2].toLowerCase() : '–æ–±—ã—á–Ω—ã–π';
                            
                            if (!isNaN(balance)) {
                                console.log(`‚úÖ –ù–∞–π–¥–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å! –ë–∞–ª–∞–Ω—Å: ${balance}, –£—Ä–æ–≤–µ–Ω—å: ${level}`);
                                return {
                                    balance: balance,
                                    level: level
                                };
                            } else {
                                console.log(`‚ùå –ë–∞–ª–∞–Ω—Å –Ω–µ —á–∏—Å–ª–æ: ${parts[1]}`);
                            }
                        }
                    }
                }
                
                console.log(`‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userIdStr} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ñ–∞–π–ª–µ`);
                console.log('–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:', text.substring(0, 500));
                return { balance: 0, level: '–æ–±—ã—á–Ω—ã–π' };
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞:', error);
                
                // –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ–∫—Å–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS
                try {
                    console.log('üîÑ –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∑–∞–≥—Ä—É–∑–∫–∏...');
                    
                    const proxyUrls = [
                        `https://api.allorigins.win/raw?url=${encodeURIComponent(CONFIG.BD_FILE_URL)}`,
                        `https://corsproxy.io/?${encodeURIComponent(CONFIG.BD_FILE_URL)}`,
                        `https://api.codetabs.com/v1/proxy/?quest=${encodeURIComponent(CONFIG.BD_FILE_URL)}`
                    ];
                    
                    for (const proxyUrl of proxyUrls) {
                        try {
                            console.log(`üîÑ –ü—Ä–æ–±—É–µ–º –ø—Ä–æ–∫—Å–∏: ${proxyUrl.substring(0, 50)}...`);
                            const proxyResponse = await fetch(proxyUrl, {
                                method: 'GET',
                                cache: 'no-cache'
                            });
                            
                            if (proxyResponse.ok) {
                                const text = await proxyResponse.text();
                                console.log('üìÑ –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏');
                                
                                const lines = text.trim().split('\n');
                                
                                for (let line of lines) {
                                    line = line.trim();
                                    if (!line) continue;
                                    
                                    const parts = line.split(/\s+/);
                                    
                                    if (parts.length >= 2) {
                                        const lineUserId = parts[0].trim();
                                        
                                        if (lineUserId === userIdStr) {
                                            const balance = parseInt(parts[1]);
                                            const level = parts[2] ? parts[2].toLowerCase() : '–æ–±—ã—á–Ω—ã–π';
                                            
                                            if (!isNaN(balance)) {
                                                console.log(`‚úÖ –ù–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏! –ë–∞–ª–∞–Ω—Å: ${balance}`);
                                                return {
                                                    balance: balance,
                                                    level: level
                                                };
                                            }
                                        }
                                    }
                                }
                            }
                        } catch (proxyError) {
                            console.log(`–ü—Ä–æ–∫—Å–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª: ${proxyError.message}`);
                            continue;
                        }
                    }
                } catch (proxyError) {
                    console.error('–í—Å–µ –ø—Ä–æ–∫—Å–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏:', proxyError);
                }
                
                return { balance: 0, level: '–æ–±—ã—á–Ω—ã–π' };
            }
        }

        // ==================== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ë–ê–õ–ê–ù–°–ê ====================
        async function updateBalance(showNotification = false) {
            console.log('üîÑ –ù–∞—á–∏–Ω–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞...');
            
            const refreshBtn = document.getElementById('refresh-balance');
            const originalContent = refreshBtn.innerHTML;
            
            refreshBtn.classList.add('loading');
            refreshBtn.disabled = true;
            
            try {
                console.log('üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞...');
                const userData = await loadBalanceFromFile();
                console.log('üìà –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userData);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
                const balanceValue = userData.balance || 0;
                const levelValue = userData.level || '–æ–±—ã—á–Ω—ã–π';
                
                document.getElementById('balance-value').textContent = balanceValue.toLocaleString('ru-RU');
                document.getElementById('balance-rub').textContent = (balanceValue * CONFIG.POINT_TO_RUB).toLocaleString('ru-RU');
                document.getElementById('user-level').textContent = levelValue;
                document.getElementById('mini-balance').textContent = balanceValue.toLocaleString('ru-RU');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ä–µ–º–µ–Ω–∏
                const balanceInfo = document.querySelector('.balance-info');
                if (balanceInfo) {
                    const now = new Date();
                    balanceInfo.innerHTML = `<i class="fas fa-info-circle"></i> –û–±–Ω–æ–≤–ª–µ–Ω–æ: ${now.toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'})}`;
                }
                
                if (showNotification) {
                    showNotification(`–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω: ${balanceValue} –±–∞–ª–ª–æ–≤`, 'success');
                }
                
                console.log(`‚úÖ –ë–∞–ª–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω: ${balanceValue} –±–∞–ª–ª–æ–≤, —É—Ä–æ–≤–µ–Ω—å: ${levelValue}`);
                return balanceValue;
                
            } catch (error) {
                console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –±–∞–ª–∞–Ω—Å–∞', 'error');
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
                document.getElementById('balance-value').textContent = '0';
                document.getElementById('balance-rub').textContent = '0';
                document.getElementById('user-level').textContent = '–æ–±—ã—á–Ω—ã–π';
                document.getElementById('mini-balance').textContent = '0';
                
                return 0;
            } finally {
                refreshBtn.classList.remove('loading');
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = originalContent;
                console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
            }
        }

        // ==================== –û–ë–†–ê–ë–û–¢–ö–ê –ó–ê–î–ê–ù–ò–ô ====================
        async function handleTaskClick(taskElement) {
            const card = taskElement.closest('.task-card');
            const taskId = card.dataset.taskId;
            const taskTitle = card.querySelector('.task-title').textContent;
            const taskReward = parseInt(card.dataset.taskReward) || 100;
            
            const btn = card.querySelector('.task-action');
            btn.disabled = true;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loader" style="display: inline-block; margin-right: 8px;"></div> –û—Ç–ø—Ä–∞–≤–∫–∞...';
            
            const taskData = {
                id: taskId,
                title: taskTitle,
                reward: taskReward,
                timestamp: Date.now()
            };
            
            try {
                console.log('üéØ –ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –∑–∞–¥–∞–Ω–∏—è:', taskData);
                
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∑–∞–¥–∞–Ω–∏–π
                totalTasksTaken++;
                localStorage.setItem('total_tasks_taken', totalTasksTaken);
                document.getElementById('stat-tasks').textContent = totalTasksTaken;
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram
                console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Telegram...');
                const { userSent, groupSent } = await sendTaskNotifications(taskData);
                
                if (userSent && groupSent) {
                    showNotification('‚úÖ –ó–∞–¥–∞–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ! –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã', 'success');
                } else if (userSent) {
                    showNotification('‚úÖ –ó–∞–¥–∞–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram', 'success');
                } else if (groupSent) {
                    showNotification('‚úÖ –ó–∞–¥–∞–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ! –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω', 'success');
                } else {
                    showNotification('‚ö†Ô∏è –ó–∞–¥–∞–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ, –Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã', 'warning');
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –∏–∑ —Ñ–∞–π–ª–∞
                console.log('üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ –∑–∞–¥–∞–Ω–∏—è...');
                await updateBalance();
                
                btn.innerHTML = '<i class="fas fa-check"></i> –ü—Ä–∏–Ω—è—Ç–æ!';
                btn.style.background = 'linear-gradient(135deg, var(--success), #34D399)';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    btn.style.background = '';
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–¥–∞–Ω–∏—è:', error);
                showNotification('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–¥–∞–Ω–∏—è', 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // ==================== –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–ô –í TELEGRAM ====================
        async function sendTelegramMessage(chatId, message, parseMode = 'HTML', replyMarkup = null) {
            if (!botTokenLoaded || !CONFIG.TELEGRAM_BOT_TOKEN) {
                console.error('‚ùå –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–ª–∏ –Ω–µ –≤–∞–ª–∏–¥–µ–Ω');
                showNotification('–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', 'error');
                return false;
            }
            
            console.log(`üì§ –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç ${chatId}`);
            
            const url = `https://api.telegram.org/bot${CONFIG.TELEGRAM_BOT_TOKEN}/sendMessage`;
            
            const payload = {
                chat_id: chatId,
                text: message,
                parse_mode: parseMode
            };
            
            if (replyMarkup) {
                payload.reply_markup = replyMarkup;
            }
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                console.log('üì© –û—Ç–≤–µ—Ç Telegram API:', result);
                
                if (result.ok) {
                    console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram');
                    return true;
                } else {
                    console.error('‚ùå –û—à–∏–±–∫–∞ Telegram API:', result.description);
                    showNotification(`–û—à–∏–±–∫–∞ Telegram: ${result.description}`, 'error');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ Telegram:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', 'error');
                return false;
            }
        }

        // ==================== –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ –û –ó–ê–î–ê–ù–ò–ò ====================
        async function sendUserNotification(taskData) {
            if (!currentUser || !currentUser.id) {
                console.error('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
                return false;
            }
            
            try {
                const now = new Date();
                const timeString = now.toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const dateString = now.toLocaleDateString('ru-RU');
                
                const message = `üéØ <b>–ó–∞–¥–∞–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ –≤ —Ä–∞–±–æ—Ç—É!</b>

üìã <b>${taskData.title}</b>
üèÜ <b>–ù–∞–≥—Ä–∞–¥–∞:</b> ${taskData.reward} –±–∞–ª–ª–æ–≤
‚è∞ <b>–í—Ä–µ–º—è:</b> ${timeString}
üìÖ <b>–î–∞—Ç–∞:</b> ${dateString}

‚è≥ <i>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ 2-3 –º–∏–Ω—É—Ç—ã.</i>

üí¨ <b>–¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞:</b> @TaskGreotSupport`;

                const replyMarkup = {
                    inline_keyboard: [[
                        {
                            text: 'üí¨ –¢–µ—Ö –ø–æ–¥–¥–µ—Ä–∂–∫–∞',
                            url: 'https://t.me/TaskGreotSupport'
                        }
                    ]]
                };
                
                return await sendTelegramMessage(currentUser.id, message, 'HTML', replyMarkup);
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:', error);
                return false;
            }
        }

        // ==================== –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –í –ì–†–£–ü–ü–£ –û –ó–ê–î–ê–ù–ò–ò ====================
        async function sendGroupNotification(taskData) {
            if (!CONFIG.GROUP_CHAT_ID) {
                console.error('‚ùå –ù–µ —É–∫–∞–∑–∞–Ω GROUP_CHAT_ID –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏');
                return false;
            }
            
            try {
                const now = new Date();
                const timeString = now.toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                const dateString = now.toLocaleDateString('ru-RU');
                
                const userLink = currentUser.username 
                    ? `<a href="https://t.me/${currentUser.username}">${currentUser.first_name} ${currentUser.last_name}</a>`
                    : `<b>${currentUser.first_name} ${currentUser.last_name}</b>`;
                
                const message = `üÜï <b>–ù–û–í–´–ô –ó–ê–ö–ê–ó –ü–†–ò–ù–Ø–¢!</b>

üë§ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> ${userLink}
${currentUser.username ? `üîó <b>Username:</b> @${currentUser.username}\n` : ''}
üìã <b>–ó–∞–¥–∞–Ω–∏–µ:</b> ${taskData.title}
üéØ <b>ID –∑–∞–¥–∞–Ω–∏—è:</b> ${taskData.id}
üèÜ <b>–ù–∞–≥—Ä–∞–¥–∞:</b> ${taskData.reward} –±–∞–ª–ª–æ–≤

üÜî <b>User ID:</b> <code>${currentUser.id}</code>
‚è∞ <b>–í—Ä–µ–º—è:</b> ${timeString}
üìÖ <b>–î–∞—Ç–∞:</b> ${dateString}

<i>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–¥–∞–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.</i>`;

                const replyMarkup = {
                    inline_keyboard: [
                        [
                            {
                                text: 'üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ',
                                url: `https://t.me/taskGreot_bot/sootoadmin?start=${currentUser.id}`
                            }
                        ],
                        [
                            {
                                text: 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
                                callback_data: `user_stats_${currentUser.id}`
                            }
                        ]
                    ]
                };
                
                return await sendTelegramMessage(CONFIG.GROUP_CHAT_ID, message, 'HTML', replyMarkup);
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø—É:', error);
                return false;
            }
        }

        // ==================== –û–¢–ü–†–ê–í–ö–ê –í–°–ï–• –£–í–ï–î–û–ú–õ–ï–ù–ò–ô –û –ó–ê–î–ê–ù–ò–ò ====================
        async function sendTaskNotifications(taskData) {
            console.log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –∑–∞–¥–∞–Ω–∏–∏:', taskData);
            
            const userSent = await sendUserNotification(taskData);
            const groupSent = await sendGroupNotification(taskData);
            
            console.log(`üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤–∫–∏: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é - ${userSent}, –≤ –≥—Ä—É–ø–ø—É - ${groupSent}`);
            
            return { userSent, groupSent };
        }

        // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        function updateProfile() {
            if (!currentUser) return;
            
            const fullName = `${currentUser.first_name || ''} ${currentUser.last_name || ''}`.trim();
            document.getElementById('user-name').textContent = fullName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            
            const usernameEl = document.getElementById('user-username');
            if (usernameEl && currentUser.username) {
                usernameEl.textContent = `@${currentUser.username}`;
            }
            
            const joinDateEl = document.getElementById('user-join-date');
            if (joinDateEl && currentUser.auth_date) {
                const joinDate = new Date(currentUser.auth_date * 1000);
                joinDateEl.textContent = `–£—á–∞—Å—Ç–Ω–∏–∫ —Å ${joinDate.toLocaleDateString('ru-RU')}`;
            }
            
            loadAvatar();
            updateStreak();
        }

        function loadAvatar() {
            const avatarIcon = document.getElementById('avatar-icon');
            const avatarImg = document.getElementById('avatar-img');
            
            if (!currentUser) return;
            
            if (typeof Telegram !== 'undefined' && Telegram.WebApp && currentUser.photo_url) {
                try {
                    avatarImg.src = currentUser.photo_url;
                    avatarImg.style.display = 'block';
                    avatarIcon.style.display = 'none';
                } catch (error) {
                    showInitials();
                }
            } else {
                showInitials();
            }
            
            function showInitials() {
                avatarIcon.style.display = 'flex';
                avatarImg.style.display = 'none';
                
                const firstName = currentUser.first_name || '';
                const lastName = currentUser.last_name || '';
                const initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
                
                if (initials.trim()) {
                    avatarIcon.textContent = initials;
                    avatarIcon.style.fontSize = '2rem';
                    avatarIcon.style.fontWeight = '600';
                } else {
                    avatarIcon.className = 'fas fa-user';
                    avatarIcon.style.fontSize = '2.2rem';
                }
            }
        }

        function updateStreak() {
            const STREAK_KEY = 'taskgreot_streak';
            const LAST_DATE_KEY = 'taskgreot_last_date';
            const today = new Date().toDateString();
            
            const lastDate = localStorage.getItem(LAST_DATE_KEY);
            let streak = parseInt(localStorage.getItem(STREAK_KEY)) || 0;
            
            if (lastDate === today) {
                // –°–µ–≥–æ–¥–Ω—è —É–∂–µ –æ—Ç–º–µ—á–∞–ª–∏
            } else if (lastDate) {
                const last = new Date(lastDate);
                const now = new Date(today);
                const diffDays = Math.floor((now - last) / (1000 * 60 * 60 * 24));
                
                if (diffDays === 1) {
                    streak++;
                } else if (diffDays > 1) {
                    streak = 1;
                }
            } else {
                streak = 1;
            }
            
            localStorage.setItem(LAST_DATE_KEY, today);
            localStorage.setItem(STREAK_KEY, streak.toString());
            
            document.getElementById('stat-streak').textContent = streak;
        }

        function showNotification(text, type = 'success') {
            const notification = document.getElementById('notification');
            const textEl = document.getElementById('notification-text');
            
            if (!notification || !textEl) return;
            
            textEl.textContent = text;
            notification.className = 'notification';
            notification.classList.add(type);
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é...');
            
            // –í–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            document.querySelectorAll('.fade-in').forEach((el, i) => {
                el.style.animationDelay = `${(i + 1) * 0.1}s`;
            });
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
            await loadBotToken();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram
            await initTelegram();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
            updateProfile();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞–¥–∞–Ω–∏–π
            document.getElementById('stat-tasks').textContent = totalTasksTaken;
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.dataset.tab;
                    
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    btn.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                    
                    if (tabId === 'profile-tab') {
                        console.log('üì± –ü–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ –≤–∫–ª–∞–¥–∫—É –ø—Ä–æ—Ñ–∏–ª—è, –æ–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å');
                        updateBalance();
                    }
                });
            });
            
            // –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
            document.getElementById('refresh-balance').addEventListener('click', () => {
                console.log('üîÑ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞');
                updateBalance(true);
            });
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–æ–∫ –∑–∞–¥–∞–Ω–∏–π
            document.querySelectorAll('.task-action').forEach((btn) => {
                btn.addEventListener('click', () => handleTaskClick(btn));
            });
            
            // –ö–Ω–æ–ø–∫–∞ –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤
            document.getElementById('withdraw-btn').addEventListener('click', openWithdrawModal);
            
            // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π (–¥–ª—è –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤) ...
            
            // –¢–µ—Å—Ç–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–ª–∞–Ω—Å–∞
            const testBtn = document.createElement('button');
            testBtn.innerHTML = 'üîç –¢–µ—Å—Ç –±–∞–ª–∞–Ω—Å–∞';
            testBtn.style.position = 'fixed';
            testBtn.style.top = '10px';
            testBtn.style.left = '10px';
            testBtn.style.zIndex = '9999';
            testBtn.style.padding = '10px';
            testBtn.style.background = 'var(--primary)';
            testBtn.style.color = 'white';
            testBtn.style.border = 'none';
            testBtn.style.borderRadius = '5px';
            testBtn.style.cursor = 'pointer';
            testBtn.onclick = async () => {
                console.log('üß™ –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –±–∞–ª–∞–Ω—Å–∞...');
                console.log('ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', currentUser?.id);
                const data = await loadBalanceFromFile();
                console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≥—Ä—É–∑–∫–∏:', data);
                showNotification(`–¢–µ—Å—Ç: ${data.balance} –±–∞–ª–ª–æ–≤`, 'info');
            };
            document.body.appendChild(testBtn);
            
            // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            setTimeout(() => {
                if (currentUser?.first_name) {
                    showNotification(`üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${currentUser.first_name}!`, 'success');
                }
                
                // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
                console.log('üîÑ –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞...');
                updateBalance();
            }, 1000);
            
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
            document.addEventListener('gesturestart', (e) => e.preventDefault());
            document.addEventListener('touchmove', (e) => {
                if (e.scale !== 1) e.preventDefault();
            }, { passive: false });
            
            console.log('‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
        });

        // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω, –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤ –∏ —Ç.–¥.) –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        // ... (–≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–¥–∞, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø–æ–∫–∞–∑–∞–Ω—ã –∑–¥–µ—Å—å) ...
    </script>
</body>
</html>
